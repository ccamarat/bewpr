<!DOCTYPE html>
<html>
<head>
    <title>Proxy Window</title>
</head>
<body>
    <h1>Proxy</h1>
    <table><tr><td>
        <button onclick="sendPostMessageToChild();">Send Message to Child via PostMessage</button><br />
        <button onclick="sendPostMessageStackbustToChild();">Send Message to Child via PostMessageStackbust</button><br />
        <button onclick="sendPostMessagePassthroughToChild();">Send Message to Child via PostMessagePassthrough</button><br />
        <!-- <button onclick="sendPostMessagePassthroughStackbustToChild();">Send Message to Child via PostMessagePassthroughStackbust</button><br /> -->
    </td>
    <td>
        <button onclick="sendPostMessageToParent();">Send postMessage to Parent</button><br />
        <button onclick="sendPostMessageStackbustToParent();">Send postMessageStackbust to Parent</button><br />
        <button onclick="sendPostMessagePassthroughToParent();">Send postMessagePassthrough to Parent</button><br />
        <!-- <button onclick="sendPostMessagePassthroughStackbustToParent();">Send postMessagePassthroughStackbust to Parent</button><br /> -->
    </td></tr></table>
    <iframe id="frmSub" src="http://popups.prodemand.com/PostMessage/dataCollection/iframe.htm"></iframe>
    <div id="divMsgs"></div>

    <script>
        var oFrame = document.getElementById("frmSub");
        var oDiv = document.getElementById('divMsgs');
        // senders

        // *** postMessage ***
        sendPostMessageToChild = function (s) {
            oFrame.contentWindow.postMessage(s || "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessage", "*");
        }
        sendPostMessageToParent = function (s) {
            window.opener.postMessage(s || "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessage", "*");
        }

        // *** postMessageStackbust ***
        function sendPostMessageStackbustToChild(s) {
            var msg = "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessageStackBust"
            setTimeout('sendPostMessageToChild("' + (s || msg) + '")', 0);
        }
        function sendPostMessageStackbustToParent(s) {
            var msg = "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessageStackBust"
            setTimeout('sendPostMessageToParent("' + (s || msg) + '")', 0);
        }

        // *** postMessagePassthrough ***
        sendPostMessagePassthroughToChild = function (s) {
            oFrame.contentWindow.postMessagePassthrough(s || "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessagePassthrough", "*");
        }
        sendPostMessagePassthroughToParent = function (s) {
            window.opener.postMessagePassthrough(s || "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessagePassthrough", "*");
        }

        // *** postMessagePassthroughStackbust ***
        sendPostMessagePassthroughStackbustToChild = function (s) {
            oFrame.contentWindow.postMessagePassthroughStackbust(s || "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessagePassthroughStackbust", "*");
        }
        sendPostMessagePassthroughStackbustToParent = function (s) {
            window.opener.postMessagePassthroughStackbust(s || "Source: <b>Proxy</b>. Domain: " + document.domain + ". <b>Via</b>: postMessagePassthroughStackbust", "*");
        }

        // Receivers

        // *** postMessage ***
        function logMessage(e) {
            oDiv.innerHTML += "<b>" + e.origin + " says:</b> " + e.data + "<br/>";
            sendPostMessageToChild(e.data);
            sendPostMessageToParent(e.data);
        }
        if (document.addEventListener) {
            window.addEventListener("message", logMessage, false);
        }
        else if (window.attachEvent) {
            window.attachEvent('onmessage', logMessage);
        }

        // *** postMessagePassthrough ***
        function postMessagePassthrough(s) {
            oDiv.innerHTML += s + "<br/>";
            sendPostMessagePassthroughToChild(s);
            sendPostMessagePassthroughToParent(s);
        }

        // *** postMessagePassthroughStackbust ***
        function postMessagePassthroughStackbust(s) {
            strCode = 'postMessagePassthrough("' + s + '");';
            setTimeout(strCode, 0);
            sendPostMessagePassthroughStackbustToChild(s);
            sendPostMessagePassthroughStackbustToParent(s);
        }
    </script>
    <style>
        iframe {
            width: 800px;
            height: 500px;
        }
    </style>
</body>
</html>
