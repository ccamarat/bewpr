{"version":3,"file":"bewpr.js","sources":["../src/enums.js","../src/HeartbeatMonitor.js","../src/Serializer.js","../src/MessageQueue.js","../src/Socket.js","../src/HostSocket.js","../src/Host.js","../src/HeartbeatProvider.js","../src/Guest.js"],"sourcesContent":["export const DEFAULT_HEALTH_CHECK_INTERVAL = 1000;\r\nexport const DEFAULT_TIMEOUT = 5000;\r\n\r\n/**\r\n * Possible message types sent/recv'd by a socket\r\n * @type {{DATA: string, START: string, HEARTBEAT: string}}\r\n */\r\nexport const MESSAGE_TYPES = {\r\n  DATA: 'data',\r\n  START: 'start',\r\n  ACK: 'ack',\r\n  HEARTBEAT: 'heartbeat'\r\n};\r\n\r\nexport const isIE = window.ActiveXObject || 'ActiveXObject' in window;\r\n","import { DEFAULT_HEALTH_CHECK_INTERVAL } from './enums';\r\n\r\nexport class HeartbeatMonitor {\r\n  constructor (host, sockets) {\r\n    this._lasthealthPoll = Date.now();\r\n    this._host = host;\r\n    this._sockets = sockets;\r\n    this._timerId = null;\r\n  }\r\n\r\n  /**\r\n     * starts monitoring the sockets array (if it's not already doing so)\r\n     */\r\n  start () {\r\n    if (!this._timerId) {\r\n      this._monitor();\r\n    }\r\n  }\r\n\r\n  _monitor () {\r\n    // indicates whether any active sockets were found. Used to optionally stop monitoring.\r\n    let hasActiveSockets = false;\r\n\r\n    // loop through the socket array and make sure everyone's playing nice.\r\n    this._sockets.forEach((socket) => {\r\n      if (!socket) {\r\n        return;\r\n      }\r\n\r\n      // Indicate that someone's alive\r\n      hasActiveSockets = true;\r\n\r\n      // Close any sockets who'se peers have disappeared into the ether.\r\n      if (socket.isStarted && this._lasthealthPoll - socket.lastPeerCheckin > socket.timeout) {\r\n        this._host.close(socket);\r\n      }\r\n    });\r\n\r\n    // Update\r\n    this._lasthealthPoll = Date.now();\r\n\r\n    // If nobody's around, stop paying attention\r\n    if (!hasActiveSockets) {\r\n      this.stop();\r\n    }\r\n\r\n    this._timerId = window.setTimeout(this._monitor.bind(this), DEFAULT_HEALTH_CHECK_INTERVAL);\r\n  }\r\n\r\n  /**\r\n     * Stops monitoring the sockets array.\r\n     */\r\n  stop () {\r\n    if (this._timerId) {\r\n      window.clearTimeout(this._timerId);\r\n      this._timerId = null;\r\n    }\r\n  }\r\n}\r\n","export const Serializer = {\r\n  serialize: JSON.stringify,\r\n  deserialize: JSON.parse\r\n};\r\n","const makeId = () => Date.now() + Math.random();\r\n\r\nexport class MessageQueue {\r\n  constructor () {\r\n    this._items = {};\r\n    this._handled = [];\r\n    this._failed = [];\r\n  }\r\n\r\n  add (resolver) {\r\n    const id = makeId();\r\n\r\n    this._items[id] = resolver;\r\n\r\n    return id;\r\n  }\r\n\r\n  acknowledge (id) {\r\n    const item = this._items[id];\r\n\r\n    if (item) {\r\n      clearTimeout(item.timerId);\r\n      item.resolve();\r\n      delete this._items[id];\r\n      this._handled.push(id);\r\n    }\r\n  }\r\n\r\n  clear () {\r\n    const ids = Object.keys(this._items);\r\n    for (let ix = 0; ix < ids.length; ix++) {\r\n      const id = ids[ix];\r\n      clearTimeout(this._items[id].timerId);\r\n      delete this._items[id];\r\n    }\r\n  }\r\n\r\n  fail (id, error) {\r\n    const item = this._items[id];\r\n\r\n    if (item) {\r\n      item.reject(error);\r\n      delete this._items[id];\r\n      this._failed.push(id);\r\n    }\r\n  }\r\n}\r\n","import { Serializer } from './Serializer';\r\nimport { MESSAGE_TYPES, DEFAULT_TIMEOUT } from './enums';\r\nimport { MessageQueue } from './MessageQueue';\r\n\r\n/**\r\n * The socket is the primary means a client communicates with a peer server.\r\n */\r\nexport class Socket {\r\n  /**\r\n     * Creates a socket instance.\r\n     * @param id - this instance's id. Used to locate it when message is received.\r\n     * @param target - the socket's communication target.\r\n     * @param peerId - The id of the peer socket.\r\n     * @param timeout - Max time to wait for an ack to any message.\r\n     */\r\n  constructor (id, target, peerId, timeout = DEFAULT_TIMEOUT) {\r\n    this.messages = new MessageQueue();\r\n\r\n    this.id = id;\r\n\r\n    this.peerId = peerId;\r\n\r\n    this.target = target;\r\n\r\n    this.timeout = timeout;\r\n\r\n    // For health monitoring - indicate the last time the peer checked in telling us it's alive\r\n    this.lastPeerCheckin = 0;\r\n\r\n    // Indicates whether the peer has started\r\n    this.isStarted = false;\r\n\r\n    // Disable the socket when its closed.\r\n    this._isClosed = false;\r\n  }\r\n\r\n  /**\r\n     * will send a message to the socket's peer\r\n     * @param message - message to send\r\n     * @param type - type of message to send. Defaults to \"DATA\"\r\n     */\r\n  send (message, type = MESSAGE_TYPES.DATA) {\r\n    if (this._isClosed) {\r\n      return Promise.reject(new Error('socket is closed.'));\r\n    }\r\n    if (type === MESSAGE_TYPES.START) {\r\n      this.isStarted = true;\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      // eslint-disable-next-line prefer-const\r\n      let packet;\r\n      const resolver = {\r\n        resolve,\r\n        reject,\r\n        timerId: window.setTimeout(() => {\r\n          this.messages.fail(packet.messageId, new Error('TIMEOUT'));\r\n        }, this.timeout)\r\n      };\r\n\r\n      packet = {\r\n        sourceId: this.id,\r\n        targetId: this.peerId,\r\n        messageId: this.messages.add(resolver),\r\n        message,\r\n        type\r\n      };\r\n\r\n      this._send(Serializer.serialize(packet));\r\n    });\r\n  }\r\n\r\n  /**\r\n     * Acknowledges a message.\r\n     * @param messageId message ID to ack.\r\n     */\r\n  ack (messageId) {\r\n    if (this._isClosed) {\r\n      return;\r\n    }\r\n\r\n    const packet = {\r\n      sourceId: this.id,\r\n      targetId: this.peerId,\r\n      messageId,\r\n      message: '',\r\n      type: MESSAGE_TYPES.ACK\r\n    };\r\n\r\n    this._send(Serializer.serialize(packet));\r\n  }\r\n\r\n  _send (message) {\r\n    this.target.postMessage(message, '*');\r\n  }\r\n\r\n  /**\r\n     * Closes the socket. Also triggers the \"onClose\" callback if supplied.\r\n     */\r\n  close () {\r\n    if (!this._isClosed) {\r\n      this.messages.clear();\r\n      this.onClose();\r\n      this._isClosed = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n     * Handles a deserialized packet from a peer.\r\n     * @param packet packet to handle\r\n     */\r\n  handle (packet) {\r\n    if (this._isClosed) {\r\n      return;\r\n    }\r\n\r\n    this.lastPeerCheckin = Date.now();\r\n\r\n    switch (packet.type) {\r\n      case MESSAGE_TYPES.START:\r\n        this.onStart();\r\n        this.isStarted = true;\r\n        break;\r\n      case MESSAGE_TYPES.ACK:\r\n        this.messages.acknowledge(packet.messageId);\r\n        break;\r\n      case MESSAGE_TYPES.HEARTBEAT:\r\n        break;\r\n      default:\r\n        this.onMessage(packet.message);\r\n    }\r\n\r\n    // Acknowledge all messages.\r\n    if (packet.type !== MESSAGE_TYPES.ACK) {\r\n      this.ack(packet.messageId);\r\n    }\r\n  }\r\n\r\n  /**\r\n     * Stub method; intended to be overridden by the consumer. This method is called when the socket is closed.\r\n     */\r\n  onClose () {\r\n    // Stub handler, intended to be overridden.\r\n  }\r\n\r\n  /**\r\n     * Stub method; intended to be overridden by the consumer. This method is called when the socket receives a message\r\n     * from its peer.\r\n     */\r\n  onMessage () {\r\n    // Stub handler, intended to be overridden.\r\n  }\r\n\r\n  /**\r\n     * Stub method; intended to be overridden by the consumer. This method is called when the socket receives the first\r\n     * message from its peer, meaning the connection is officially active.\r\n     */\r\n  onStart () {\r\n    // Stub handler, intended to be overridden.\r\n  }\r\n}\r\n","import { Socket } from './Socket';\r\nimport { isIE } from './enums';\r\n\r\nexport class HostSocket extends Socket {\r\n  _send (message) {\r\n    if (isIE) {\r\n      this.target.toGuest(message);\r\n    } else {\r\n      super._send(message);\r\n    }\r\n  }\r\n}\r\n","import { HeartbeatMonitor } from './HeartbeatMonitor';\r\nimport { Serializer } from './Serializer';\r\nimport { HostSocket } from './HostSocket';\r\nimport { DEFAULT_TIMEOUT, isIE } from './enums';\r\n\r\nconst DEFAULT_GUEST_OPTIONS = {\r\n  windowOptions: 'left=0,top=0,height=900,width=800,status=yes,toolbar=no,menubar=no,location=yes',\r\n  timeout: DEFAULT_TIMEOUT\r\n};\r\n\r\nexport class Host {\r\n  constructor () {\r\n    this._sockets = [];\r\n    // Listen for postMessage events\r\n    if (isIE) {\r\n      window.fromGuest = this._onMessage.bind(this);\r\n    } else {\r\n      window.addEventListener('message', this._onMessage.bind(this), false);\r\n    }\r\n\r\n    // Create the health monitor\r\n    this._healthMonitor = new HeartbeatMonitor(this, this._sockets);\r\n  }\r\n\r\n  _onMessage (message) {\r\n    const packet = Serializer.deserialize(message.data);\r\n    const socket = this._sockets[packet.targetId];\r\n\r\n    // verify the socket reference\r\n    if (!socket) {\r\n      // probably what happened is the user refreshed the client page and the server's\r\n      // still sending messages. Not much we can do but ignore it. The server should clean\r\n      // itself up eventually.\r\n      return;\r\n    }\r\n\r\n    socket.handle(packet);\r\n  }\r\n\r\n  /**\r\n     * creates a guest session by opening a new window and passing that reference to a socket instance,\r\n     * then returns the socket\r\n     * @param options\r\n     * @returns {Socket}\r\n     */\r\n  create (\r\n    { target, windowOptions = DEFAULT_GUEST_OPTIONS.windowOptions, timeout = DEFAULT_GUEST_OPTIONS.timeout }\r\n    = DEFAULT_GUEST_OPTIONS) {\r\n    let pTarget = target;\r\n    // the socket id is simply the next available slot in the sockets array\r\n    const socketId = this._sockets.length;\r\n\r\n    // The 'endpoint' is the target window\r\n    if (isIE) {\r\n      const proxy = './ie-proxy.html';\r\n\r\n      pTarget = `${proxy}?guest=${pTarget}`;\r\n    }\r\n    const endpoint = window.open(pTarget, socketId.toString(), windowOptions);\r\n\r\n    // new up a socket and store it in our socket's array\r\n    const socket = new HostSocket(socketId, endpoint, undefined, timeout);\r\n\r\n    this._sockets.push(socket);\r\n\r\n    // ensure socket monitoring is active (it stops polling when all sockets are closed)\r\n    this._healthMonitor.start();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const timerId = setTimeout(() => {\r\n        this.close(socket);\r\n        reject(new Error('TIMEOUT'));\r\n      }, timeout);\r\n\r\n      socket.onStart = () => {\r\n        clearTimeout(timerId);\r\n        resolve(socket);\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n     * Close the socket, which renders it pretty much useless.\r\n     * @param socket\r\n     */\r\n  close (socket) {\r\n    if (socket.target) {\r\n      socket.target.close();\r\n    }\r\n    socket.close();\r\n    this._sockets[socket.id] = null;\r\n  }\r\n\r\n  /**\r\n     * shuts down the host.\r\n     */\r\n  shutdown () {\r\n    for (let ix = 0; ix < this._sockets.length; ix++) {\r\n      this.close(this._sockets[ix]);\r\n    }\r\n    this._sockets.length = 0;\r\n  }\r\n}\r\n","import { DEFAULT_HEALTH_CHECK_INTERVAL, MESSAGE_TYPES } from './enums';\r\n\r\n/**\r\n * HeartbeatProvider; includes automatic heartbeat.\r\n */\r\nexport class HeartbeatProvider {\r\n  constructor (socket) {\r\n    this._socket = socket;\r\n  }\r\n\r\n  /**\r\n     * Signals that the socket is configured and can start reporting heartbeats.\r\n     */\r\n  start () {\r\n    this._socket.send('', MESSAGE_TYPES.START);\r\n    this._sendHeartbeat();\r\n  }\r\n\r\n  stop () {\r\n    window.clearTimeout(this._timerId);\r\n  }\r\n\r\n  _sendHeartbeat () {\r\n    this._socket.send('', MESSAGE_TYPES.HEARTBEAT).catch(() => this.onFail());\r\n\r\n    this._timerId = window.setTimeout(this._sendHeartbeat.bind(this), DEFAULT_HEALTH_CHECK_INTERVAL);\r\n  }\r\n\r\n  onFail () {\r\n    // Stub handler, intended to be overridden.\r\n  }\r\n}\r\n","import { Serializer } from './Serializer';\r\nimport { Socket } from './Socket';\r\nimport { HeartbeatProvider } from './HeartbeatProvider';\r\n\r\nconst DEFAULT_SERVER_SOCKET_ID = 0;\r\n\r\n/**\r\n * The \"Guest\" is launched by the host. Typically hosts control guests, but guests can send messages to the host as\r\n * well.\r\n */\r\nexport class Guest {\n  /**\r\n     * Signals that the guest has been configured and is ready to send / receive messages\r\n     */\r\n  start () {\r\n    this._socket = new Socket(DEFAULT_SERVER_SOCKET_ID, window.opener || window.top, parseInt(window.name, 10));\r\n\r\n    this._socket.onMessage = (...args) => {\r\n      this.onReceiveMessage && this.onReceiveMessage(...args);\r\n    };\r\n\r\n    window.addEventListener('message', this._onMessage.bind(this), false);\r\n\r\n    const heartbeat = new HeartbeatProvider(this._socket);\r\n\r\n    heartbeat.onFail = () => {\r\n      heartbeat.stop();\r\n      this.close();\r\n    };\r\n\r\n    // Setup an event to notify the client that we're ready to send messages\r\n    window.addEventListener('load', () => {\r\n      heartbeat.start();\r\n    }, false);\r\n  }\r\n\r\n  _onMessage (message) {\r\n    // On page reloads when the parent window is closed, postMessage sends to itself.\r\n    if (message.source === window) {\r\n      return;\r\n    }\r\n    const packet = Serializer.deserialize(message.data);\r\n\r\n    this._socket.handle(packet);\r\n  }\r\n\r\n  /**\r\n     * Sends a message to the host.\r\n     * @param message\r\n     */\r\n  sendMessage (message) {\r\n    this._socket.send(message);\r\n  }\r\n\r\n  /**\r\n     * Closes the guest window!\r\n     */\r\n  close () {\r\n    this.onClose();\r\n    window.close();\r\n  }\r\n\r\n  /**\r\n     * Lookup the Host's peer ID. Useful for debugging but not much else.\r\n     * @returns {*}\r\n     */\r\n  get id () {\r\n    return this._socket.peerId;\r\n  }\r\n\r\n  onClose () {\r\n    // Stub handler, intended to be overridden.\r\n  }\r\n}\r\n"],"names":["DEFAULT_HEALTH_CHECK_INTERVAL","DEFAULT_TIMEOUT","MESSAGE_TYPES","DATA","START","ACK","HEARTBEAT","isIE","window","ActiveXObject","HeartbeatMonitor","host","sockets","_lasthealthPoll","Date","now","_host","_sockets","_timerId","_monitor","hasActiveSockets","forEach","socket","isStarted","lastPeerCheckin","timeout","close","stop","setTimeout","bind","clearTimeout","Serializer","serialize","JSON","stringify","deserialize","parse","makeId","Math","random","MessageQueue","_items","_handled","_failed","resolver","id","item","timerId","resolve","push","ids","Object","keys","ix","length","error","reject","Socket","target","peerId","messages","_isClosed","message","type","Promise","Error","packet","fail","messageId","sourceId","targetId","add","_send","postMessage","clear","onClose","onStart","acknowledge","onMessage","ack","HostSocket","toGuest","DEFAULT_GUEST_OPTIONS","windowOptions","Host","fromGuest","_onMessage","addEventListener","_healthMonitor","data","handle","pTarget","socketId","proxy","endpoint","open","toString","undefined","start","HeartbeatProvider","_socket","send","_sendHeartbeat","catch","onFail","DEFAULT_SERVER_SOCKET_ID","Guest","opener","top","parseInt","name","onReceiveMessage","heartbeat","source"],"mappings":"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"}