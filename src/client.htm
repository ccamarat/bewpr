<!DOCTYPE html>
<html>
<head>
    <title>Client Window</title>
</head>
<body>
    <h1>Client</h1>
    <button onclick="sendMessage();">Send Message</button><br />
    <hr />
    <button onclick="openPopup();">Create Server</button><br />
    <div id="divMsgs"></div>

    <script src="browser.cheat.js"></script>
    <script>
        var server,
            transportSupportsPostMessage = BrowserInfo.supportsPostMessage,
            transportRequiresStackbust = BrowserInfo.requiresStackbust,
            serverUrl = 'http://popups.prodemand.com/PostMessage/server.htm',
            proxyUrl = 'http://prototypes.prodemand.com/PostMessage/proxy.htm',
            oDiv = document.getElementById('divMsgs');

        function openPopup() {
            if (transportSupportsPostMessage) {
                server = window.open(serverUrl, "IntegrationServicesServer", "left=0,top=0,height=900,width=800,status=yes,toolbar=no,menubar=no,location=yes");
            }
            else {
                server = window.open(proxyUrl + '?server=' + serverUrl, "IntegrationServicesProxy", "left=0,top=0,height=900,width=800,status=yes,toolbar=no,menubar=no,location=yes");
            }
        }

        // senders
        sendMessage = function(s) {
            var msg = s || ("Source: <b>Client</b>. Domain: " + document.domain + ". <b>Via</b>: postMessage");
            if (transportSupportsPostMessage) {
                server.postMessage(msg, "*");
            }
            else if (transportRequiresStackbust) {
                server.postMessagePassthroughStackbust(msg);
            }
            else {
                server.postMessagePassthrough(msg);
            }
        }

        // Receivers
        if (transportSupportsPostMessage) {
            function logMessage(e) {
                oDiv.innerHTML += "<b>" + e.origin + " says:</b> " + e.data + "<br/>";
            }
            if (document.addEventListener) {
                window.addEventListener("message", logMessage, false);
            }
            else if (window.attachEvent) {
                window.attachEvent('onmessage', logMessage);
            }
        }
        else {
            window.postMessagePassthrough = function (s) {
                oDiv.innerHTML += s + "<br/>";
            }
        }
    </script>
</body>
</html>
